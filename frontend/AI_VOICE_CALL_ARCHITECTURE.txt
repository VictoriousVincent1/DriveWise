# AI Voice Call Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        USER EXPERIENCE                           │
└─────────────────────────────────────────────────────────────────┘

   User clicks "📞 Call Me" → Enters phone number → Receives call
                                                            ↓
                                                     [Phone rings]
                                                            ↓
                                        "Hello! I'm the ToyotaPath assistant..."
                                                            ↓
                                                  User speaks question
                                                            ↓
                                              AI responds naturally


┌─────────────────────────────────────────────────────────────────┐
│                      TECHNICAL FLOW                              │
└─────────────────────────────────────────────────────────────────┘

┌──────────────┐         ┌──────────────┐         ┌──────────────┐
│   Frontend   │         │   Backend    │         │    Twilio    │
│  (Browser)   │         │  API Routes  │         │   Service    │
└──────┬───────┘         └──────┬───────┘         └──────┬───────┘
       │                        │                        │
       │ 1. Click "Call Me"     │                        │
       ├───────────────────────>│                        │
       │                        │                        │
       │ 2. POST /api/voice-call/initiate               │
       │                        ├───────────────────────>│
       │                        │   { phoneNumber,       │
       │                        │     context }          │
       │                        │                        │
       │                        │ 3. Twilio makes call   │
       │                        │<───────────────────────┤
       │                        │                        │
       │                        │                        ├──> [User's Phone]
       │                        │                        │         rings!
       │ 4. Call initiated ✓    │                        │
       │<───────────────────────┤                        │
       │                        │                        │
       │                        │ 5. TwiML webhook       │
       │                        │<───────────────────────┤
       │                        │ GET /api/voice-call/twiml
       │                        │                        │
       │                        │ 6. Returns greeting    │
       │                        ├───────────────────────>│
       │                        │ <Play audio URL>       │
       │                        │                        │
       │                        │ 7. Get speech audio    │
       │                        │<───────────────────────┤
       │                        │ GET /api/voice-call/speak?text=...
       │                        │                        │
       │                        ├──> [ElevenLabs API]    │
       │                        │    Convert text to     │
       │                        │    natural voice       │
       │                        │<─── [Returns MP3]      │
       │                        │                        │
       │                        │ 8. Play to user        │
       │                        ├───────────────────────>│──> User hears
       │                        │                        │    AI voice
       │                        │                        │
       │                        │ 9. User speaks         │
       │                        │<───────────────────────┤
       │                        │ POST /api/voice-call/process
       │                        │ { SpeechResult: "..." }│
       │                        │                        │
       │                        │ 10. Generate AI response
       │                        │    (check keywords)    │
       │                        │                        │
       │                        │ 11. Return TwiML       │
       │                        ├───────────────────────>│
       │                        │ <Play response audio>  │
       │                        │ <Gather next input>    │
       │                        │                        │
       │                        │ ...conversation continues...
       │                        │                        │
       │                        │ 12. User says goodbye  │
       │                        │<───────────────────────┤
       │                        │                        │
       │                        │ 13. End call TwiML     │
       │                        ├───────────────────────>│
       │                        │ <Hangup>               │
       │                        │                        │
       └────────────────────────┴────────────────────────┘


┌─────────────────────────────────────────────────────────────────┐
│                      KEY COMPONENTS                              │
└─────────────────────────────────────────────────────────────────┘

🎤 SPEECH INPUT
   ├─ Twilio captures user voice
   ├─ Converts speech to text automatically
   └─ Sends to /process endpoint

🧠 AI PROCESSING
   ├─ Analyzes user intent
   ├─ Matches keywords (RAV4, finance, dealer, etc.)
   ├─ Generates contextual response
   └─ Optional: Use OpenAI for advanced AI

🗣️ VOICE OUTPUT
   ├─ Response text sent to ElevenLabs
   ├─ ElevenLabs generates natural voice (MP3)
   ├─ Twilio plays audio to user
   └─ Sounds like a real person!

📊 TRACKING
   ├─ /status endpoint logs call events
   ├─ /recording endpoint saves recordings
   └─ Analytics for call quality


┌─────────────────────────────────────────────────────────────────┐
│                    API ENDPOINTS CREATED                         │
└─────────────────────────────────────────────────────────────────┘

POST /api/voice-call/initiate
  ↳ Starts the phone call

POST /api/voice-call/twiml
  ↳ Controls call flow and greeting

POST /api/voice-call/process
  ↳ Handles user speech and generates responses

GET /api/voice-call/speak?text=...
  ↳ Converts text to speech via ElevenLabs

POST /api/voice-call/status
  ↳ Tracks call status (ringing, answered, ended)

POST /api/voice-call/recording
  ↳ Handles call recordings for quality assurance


┌─────────────────────────────────────────────────────────────────┐
│                       ENVIRONMENT SETUP                          │
└─────────────────────────────────────────────────────────────────┘

Required in .env.local:

TWILIO_ACCOUNT_SID=ACxxxxxxxxxxxxxx
  ↳ From Twilio Console

TWILIO_AUTH_TOKEN=xxxxxxxxxxxx
  ↳ From Twilio Console (keep secret!)

TWILIO_PHONE_NUMBER=+15551234567
  ↳ Purchase from Twilio ($1-2/month)

NEXT_PUBLIC_BASE_URL=https://your-url.com
  ↳ For webhooks (use ngrok for local testing)

NEXT_PUBLIC_ELEVENLABS_API_KEY=agent_9401...
  ↳ Already configured ✅


┌─────────────────────────────────────────────────────────────────┐
│                         COST BREAKDOWN                           │
└─────────────────────────────────────────────────────────────────┘

Twilio Phone Number:    $1-2/month
Outbound Calls (US):    $0.013/minute
Call Recording:         $0.0025/minute
ElevenLabs:            $5/month (30K characters)

Example: 10 calls/day × 3 minutes average
  = ~300 minutes/month
  = $3.90 in call costs
  = $1 for phone number
  = $5 for ElevenLabs
  ────────────────────────
  = $9.90/month total 💰


┌─────────────────────────────────────────────────────────────────┐
│                      CONVERSATION EXAMPLES                       │
└─────────────────────────────────────────────────────────────────┘

Example 1: Vehicle Inquiry
─────────────────────────
User: "Tell me about the RAV4"
AI:   "The RAV4 is our most popular SUV! The 2024 RAV4 XLE 
       starts at $36,800. It features all-wheel drive, 
       excellent fuel economy at 27 city and 35 highway MPG..."

Example 2: Financing Question
────────────────────────────
User: "What financing options do you have?"
AI:   "We offer both financing and leasing options! Current 
       rates start at 4.9% APR for qualified buyers, and 
       lease payments begin at $329 per month..."

Example 3: Dealer Locator
────────────────────────
User: "Where's the nearest dealer?"
AI:   "We have 5 certified Toyota dealers in your area. 
       The closest one is Toyota of Downtown, just 2.3 miles 
       away, with a 4.8 star rating..."


✨ That's the complete AI Voice Call system! ✨
```
